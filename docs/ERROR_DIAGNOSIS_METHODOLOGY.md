# üî¨ –ú–µ—Ç–æ–¥–æ–ª–æ–≥–∏—è –¥–∏–∞–≥–Ω–æ—Å—Ç–∏–∫–∏ –æ—à–∏–±–æ–∫ –≤ Multi-Agent Pipeline

**–°–∏—Å—Ç–µ–º–∞—Ç–∏—á–µ—Å–∫–∏–π –ø–æ–¥—Ö–æ–¥ –∫ –ø–æ–∏—Å–∫—É –∏ –∏—Å–ø—Ä–∞–≤–ª–µ–Ω–∏—é –ø—Ä–æ–±–ª–µ–º**

---

## üìä –î–∏–∞–≥—Ä–∞–º–º–∞ —É—Ä–æ–≤–Ω–µ–π —Å–∏—Å—Ç–µ–º—ã

```
‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê
‚îÇ Level 1: Frontend (React + Supabase SDK)                        ‚îÇ
‚îÇ ‚îî‚îÄ –í—ã–∑—ã–≤–∞–µ—Ç /functions/v1/search-orchestrator                   ‚îÇ
‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò
                              ‚Üì
‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê
‚îÇ Level 2: Orchestrator (search-orchestrator function)            ‚îÇ
‚îÇ ‚îî‚îÄ –í—ã–∑—ã–≤–∞–µ—Ç search-orchestrator                                 ‚îÇ
‚îÇ ‚îî‚îÄ –ö–æ–æ—Ä–¥–∏–Ω–∏—Ä—É–µ—Ç: source-hunter ‚Üí content-fetcher ‚Üí processor    ‚îÇ
‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò
                              ‚Üì
‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê
‚îÇ Level 3: Agents (Edge Functions)                                ‚îÇ
‚îÇ ‚îú‚îÄ source-hunter (–ø–æ–∏—Å–∫ –∏—Å—Ç–æ—á–Ω–∏–∫–æ–≤)                             ‚îÇ
‚îÇ ‚îú‚îÄ content-fetcher (–∑–∞–≥—Ä—É–∑–∫–∞ –∫–æ–Ω—Ç–µ–Ω—Ç–∞)                          ‚îÇ
‚îÇ ‚îî‚îÄ document-processor (–æ–±—Ä–∞–±–æ—Ç–∫–∞)                               ‚îÇ
‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò
                              ‚Üì
‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê
‚îÇ Level 4: Database (PostgreSQL + RLS)                            ‚îÇ
‚îÇ ‚îú‚îÄ sources, documents, search_runs, etc.                        ‚îÇ
‚îÇ ‚îî‚îÄ Row Level Security policies                                  ‚îÇ
‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò

–û—à–∏–±–∫–∏ –º–æ–≥—É—Ç –±—ã—Ç—å –Ω–∞ –õ–Æ–ë–û–ú —É—Ä–æ–≤–Ω–µ!
```

---

## üéØ –ê–ª–≥–æ—Ä–∏—Ç–º –¥–∏–∞–≥–Ω–æ—Å—Ç–∏–∫–∏ –ø–æ —É—Ä–æ–≤–Ω—è–º

### –£—Ä–æ–≤–µ–Ω—å 1: Frontend Issue?

**–°–∏–º–ø—Ç–æ–º—ã:**
```
‚Ä¢ Frontend –Ω–µ –º–æ–∂–µ—Ç –≤—ã–∑–≤–∞—Ç—å —Ñ—É–Ω–∫—Ü–∏—é
‚Ä¢ CORS –æ—à–∏–±–∫–∞
‚Ä¢ 401/403 auth –æ—à–∏–±–∫–∞
‚Ä¢ Request –Ω–µ –æ—Ç–ø—Ä–∞–≤–ª—è–µ—Ç—Å—è –≤–æ–æ–±—â–µ
```

**–î–∏–∞–≥–Ω–æ—Å—Ç–∏–∫–∞:**
```bash
# 1. –ü—Ä–æ–≤–µ—Ä—å —á—Ç–æ —Ñ—É–Ω–∫—Ü–∏—è URL –ø—Ä–∞–≤–∏–ª—å–Ω–∞—è
const functionUrl = `${supabaseUrl}/functions/v1/search-orchestrator`;
console.log('Calling:', functionUrl);

# 2. –ü—Ä–æ–≤–µ—Ä—å auth token
const { data: session } = await supabase.auth.getSession();
console.log('Has session:', !!session);

# 3. –ü—Ä–æ–≤–µ—Ä—å CORS headers –≤ —Ñ—É–Ω–∫—Ü–∏–∏
// –í index.ts Edge Function –¥–æ–ª–∂–Ω—ã –±—ã—Ç—å:
const corsHeaders = {
  'Access-Control-Allow-Origin': '*',
  'Access-Control-Allow-Headers': '...',
};

# 4. –í—ã–∑–æ–≤–∏ —Ñ—É–Ω–∫—Ü–∏—é –Ω–∞–ø—Ä—è–º—É—é (–º–∏–Ω—É—è frontend)
curl -X POST https://project.supabase.co/functions/v1/search-orchestrator \
  -H "apikey: $ANON_KEY" \
  -H "Content-Type: application/json" \
  -d '{"monitoring_profile_id":"test"}'

# –ï—Å–ª–∏ curl —Ä–∞–±–æ—Ç–∞–µ—Ç –Ω–æ frontend –Ω–µ —Ä–∞–±–æ—Ç–∞–µ—Ç ‚Üí frontend issue
# –ï—Å–ª–∏ curl –Ω–µ —Ä–∞–±–æ—Ç–∞–µ—Ç ‚Üí issue –Ω–∞ Level 2/3
```

---

### –£—Ä–æ–≤–µ–Ω—å 2: Orchestrator Issue?

**–°–∏–º–ø—Ç–æ–º—ã:**
```
‚Ä¢ 404 –ø—Ä–∏ –≤—ã–∑–æ–≤–µ —Ñ—É–Ω–∫—Ü–∏–∏
‚Ä¢ 500 Internal Server Error
‚Ä¢ –ù–µ–ø—Ä–∞–≤–∏–ª—å–Ω—ã–π —Ñ–æ—Ä–º–∞—Ç –æ—Ç–≤–µ—Ç–∞
‚Ä¢ –§—É–Ω–∫—Ü–∏—è —Å—É—â–µ—Å—Ç–≤—É–µ—Ç –Ω–æ –Ω–µ –æ—Ç–≤–µ—á–∞–µ—Ç
```

**–î–∏–∞–≥–Ω–æ—Å—Ç–∏–∫–∞:**

#### 2.1 –§—É–Ω–∫—Ü–∏—è —Ä–∞–∑–≤–µ—Ä–Ω—É—Ç–∞?
```bash
npx supabase functions list
# –†–µ–∑—É–ª—å—Ç–∞—Ç –¥–æ–ª–∂–µ–Ω —Å–æ–¥–µ—Ä–∂–∞—Ç—å search-orchestrator

# –ü—Ä–æ–≤–µ—Ä—å –≤–µ—Ä—Å–∏—é –∏ –≤—Ä–µ–º—è –æ–±–Ω–æ–≤–ª–µ–Ω–∏—è
npx supabase functions list | grep search-orchestrator
# –î–æ–ª–∂–Ω–æ –±—ã—Ç—å: search-orchestrator | ACTIVE | VERSION > 0 | UPDATED_AT —Å–≤–µ–∂–∏–π
```

#### 2.2 –ù–æ–≤—ã–π –∫–æ–¥ –∑–∞–ø—É—â–µ–Ω?
```bash
# –î–æ–±–∞–≤—å —è–≤–Ω—ã–π –º–∞—Ä–∫–µ—Ä –≤–µ—Ä—Å–∏–∏ –≤ –Ω–∞—á–∞–ª–æ —Ñ—É–Ω–∫—Ü–∏–∏:
console.log('üöÄ Search Orchestrator v8 started');

# –†–∞–∑–≤–µ—Ä—Ç–Ω–∏ –∏ –≤—ã–∑–æ–≤–∏:
curl -X POST https://.../functions/v1/search-orchestrator \
  -H "apikey: $ANON_KEY" \
  -d '{"monitoring_profile_id":"test"}'

# –ü—Ä–æ–≤–µ—Ä—å –≤ Dashboard ‚Üí Functions ‚Üí Logs
# –í–∏–¥–∏—à—å –ª–∏ —Ç—ã –Ω–æ–≤—ã–π –º–∞—Ä–∫–µ—Ä "v8"?

# ‚ùå –ï—Å–ª–∏ –ù–ï –≤–∏–¥–∏—à—å –Ω–æ–≤—ã–π –º–∞—Ä–∫–µ—Ä:
#    –ü—Ä–∏—á–∏–Ω–∞: –¥—É–±–ª–∏—Ä–æ–≤–∞–Ω–∏–µ —Ñ—É–Ω–∫—Ü–∏–∏
#    –†–µ—à–µ–Ω–∏–µ: –Ω–∞–π—Ç–∏ –∏ —É–¥–∞–ª–∏—Ç—å –¥—É–±–ª–∏—Ä—É—é—â—É—é—Å—è –≤–µ—Ä—Å–∏—é
#    find supabase/functions -type d -name search-orchestrator
#    –î–æ–ª–∂–Ω–æ –±—ã—Ç—å –û–î–ù–û —Å–æ–≤–ø–∞–¥–µ–Ω–∏–µ

# ‚úÖ –ï—Å–ª–∏ –≤–∏–¥–∏—à—å –Ω–æ–≤—ã–π –º–∞—Ä–∫–µ—Ä:
#    –§—É–Ω–∫—Ü–∏—è —Ä–∞–∑–≤–µ—Ä–Ω—É—Ç–∞ –ø—Ä–∞–≤–∏–ª—å–Ω–æ, issue –¥–∞–ª—å—à–µ
```

#### 2.3 –ü—Ä–∞–≤–∏–ª—å–Ω–æ–µ –ª–æ–≥–∏—Ä–æ–≤–∞–Ω–∏–µ?
```typescript
// ‚úÖ –ü–†–ê–í–ò–õ–¨–ù–û: —è–≤–Ω–æ –ª–æ–≥–∏—Ä—É–π –≤—Å–µ –ø–æ–ø—ã—Ç–∫–∏ –≤—ã–∑–æ–≤–∞
console.log('üîç Calling Source Hunter:', {
  url: functionUrl,
  hasAuthHeader: !!authHeader,
  documentCount: documentIds?.length,
});

const response = await fetch(functionUrl, { ... });

console.log('üì° Source Hunter response:', {
  status: response.status,
  statusText: response.statusText,
  size: response.size,
});

if (!response.ok) {
  const error = await response.text();
  console.error('‚ùå Source Hunter failed:', response.status, error);
  throw new Error(`Source Hunter failed: ${response.status}`);
}

// ‚ùå –ù–ï–ü–†–ê–í–ò–õ–¨–ù–û: –º–æ–ª—á–∞–ª–∏–≤—ã–π –æ—Ç–∫–∞–∑
const response = await fetch(functionUrl, { ... });
if (!response.ok) {
  // –ù–∏–∫–∞–∫–∏—Ö –ª–æ–≥–æ–≤!
  return { status: 'error' };
}
```

---

### –£—Ä–æ–≤–µ–Ω—å 3: Agent Function Issue?

**–°–∏–º–ø—Ç–æ–º—ã:**
```
‚Ä¢ –§—É–Ω–∫—Ü–∏—è –≤—ã–∑—ã–≤–∞–µ—Ç—Å—è –Ω–æ –≤–æ–∑–≤—Ä–∞—â–∞–µ—Ç –Ω–µ–ø—Ä–∞–≤–∏–ª—å–Ω—ã–π —Ä–µ–∑—É–ª—å—Ç–∞—Ç
‚Ä¢ –§—É–Ω–∫—Ü–∏—è –æ—á–µ–Ω—å –º–µ–¥–ª–µ–Ω–Ω–∞—è
‚Ä¢ –§—É–Ω–∫—Ü–∏—è –≤—ã–±—Ä–∞—Å—ã–≤–∞–µ—Ç –∏—Å–∫–ª—é—á–µ–Ω–∏–µ
‚Ä¢ –ù–µ–ø—Ä–∞–≤–∏–ª—å–Ω—ã–π —Ñ–æ—Ä–º–∞—Ç –æ—Ç–≤–µ—Ç–∞
```

**–î–∏–∞–≥–Ω–æ—Å—Ç–∏–∫–∞:**

#### 3.1 –§—É–Ω–∫—Ü–∏—è —Ä–µ–∞–ª—å–Ω–æ –≤—ã–∑–≤–∞–Ω–∞?
```bash
# –í—ã–∑–æ–≤–∏ —Ñ—É–Ω–∫—Ü–∏—é –Ω–∞–ø—Ä—è–º—É—é (–Ω–µ —á–µ—Ä–µ–∑ orchestrator)
curl -X POST https://.../functions/v1/source-hunter \
  -H "apikey: $ANON_KEY" \
  -H "Content-Type: application/json" \
  -d '{"prompt":"test query","segment_ids":["id1"]}'

# –ü—Ä–æ–≤–µ—Ä—å:
# 1. –ï—Å—Ç—å –ª–∏ –ª–æ–≥–∏ –≤ Dashboard ‚Üí Functions ‚Üí Logs?
# 2. –ö–∞–∫–æ–π status –∫–æ–¥? (200, 400, 500)
# 3. –ö–∞–∫–æ–π body –æ—Ç–≤–µ—Ç–∞?
```

#### 3.2 –ü–∞—Ä–∞–º–µ—Ç—Ä—ã –ø—Ä–∞–≤–∏–ª—å–Ω—ã–µ?
```typescript
// –§—É–Ω–∫—Ü–∏—è –æ–∂–∏–¥–∞–µ—Ç –ø–∞—Ä–∞–º–µ—Ç—Ä—ã –∏–∑ types.ts
// –ü—Ä–æ–≤–µ—Ä—å types.ts —á—Ç–æ —Ç–∞–º –Ω–∞–ø–∏—Å–∞–Ω–æ

export interface SourceHunterRequest {
  prompt: string;                    // REQUIRED
  segment_ids?: string[];            // OPTIONAL
  geography_ids?: string[];          // OPTIONAL
  monitoring_profile_id?: string;    // OPTIONAL
}

// –ü—Ä–∏ –≤—ã–∑–æ–≤–µ –∏–∑ orchestrator:
const body = JSON.stringify({
  prompt: promptTemplate.template_text,
  segment_ids: profile.segment_ids,
  geography_ids: profile.geography_ids,
  monitoring_profile_id: profile.id,
});

// –õ–æ–≥–∏—Ä—É–π —á—Ç–æ –æ—Ç–ø—Ä–∞–≤–ª—è–µ—à—å:
console.log('üì§ Sending to source-hunter:', body);
```

#### 3.3 –õ–æ–≥–∏—Ä–æ–≤–∞–Ω–∏–µ –≤ —Ñ—É–Ω–∫—Ü–∏–∏?
```typescript
// –û–ë–Ø–ó–ê–¢–ï–õ–¨–ù–û –ª–æ–≥–∏—Ä—É–π —Å—Ç—Ä—É–∫—Ç—É—Ä–Ω–æ:

async function handler(request: Request) {
  console.log('='.repeat(80));
  console.log('üöÄ source-hunter v3 started');
  console.log('üìå Environment:', Deno.env.get('DENO_ENV'));
  console.log('='.repeat(80));

  try {
    const body = await request.json();
    console.log('üì• Request received:', {
      prompt: body.prompt?.substring(0, 50),
      segment_ids: body.segment_ids?.length,
      geography_ids: body.geography_ids?.length,
    });

    // –®–∞–≥ 1
    console.log('Step 1/3: Loading sources...');
    const sources = await getSearchSources(body.segment_ids, body.geography_ids);
    console.log('‚úÖ Found sources:', sources.length);

    // –®–∞–≥ 2
    console.log('Step 2/3: Generating queries...');
    const queries = await generateSearchQueries(body.prompt, sources);
    console.log('‚úÖ Generated queries:', queries.size);

    // –®–∞–≥ 3
    console.log('Step 3/3: Searching and saving...');
    let created = 0;
    for (const source of sources) {
      const results = await searchDocuments(queries.get(source.id), source);
      for (const result of results) {
        const docId = await saveDocument(result.title, result.url, source.id);
        if (docId) created++;
      }
    }
    console.log('‚úÖ Documents created:', created);

    console.log('üéâ Success');
    return successResponse({ documents_created: created });
  } catch (error) {
    console.error('‚ùå Error:', error);
    return errorResponse(error);
  }
}
```

#### 3.4 –ë—ã—Å—Ç—Ä–æ –ª–∏ —Ä–∞–±–æ—Ç–∞–µ—Ç?
```bash
# –õ–æ–≥–∏—Ä—É–π –≤—Ä–µ–º—è –æ–ø–µ—Ä–∞—Ü–∏–π:
console.time('fetch-content');
const response = await fetch(url);
console.timeEnd('fetch-content');
// –†–µ–∑—É–ª—å—Ç–∞—Ç: fetch-content: 1234ms

# –ï—Å–ª–∏ –º–µ–¥–ª–µ–Ω–Ω–æ:
# ‚Ä¢ –ú–æ–∂–µ—Ç –±—ã—Ç—å —á—Ç–æ-—Ç–æ —Å network (retry, backoff)
# ‚Ä¢ –ú–æ–∂–µ—Ç –±—ã—Ç—å –º–Ω–æ–≥–æ requests (–ø–∞—Ä–∞–ª–ª–µ–ª–∏–∑–º)
# ‚Ä¢ –ú–æ–∂–µ—Ç –±—ã—Ç—å –±–ª–æ–∫–∏—Ä–æ–≤–∫–∞ –Ω–∞ –ë–î

# –†–µ—à–µ–Ω–∏–µ:
const promises = urls.map(url => fetch(url)); // –ü–∞—Ä–∞–ª–ª–µ–ª—å
const results = await Promise.all(promises);
```

---

### –£—Ä–æ–≤–µ–Ω—å 4: Database Issue?

**–°–∏–º–ø—Ç–æ–º—ã:**
```
‚Ä¢ –¢–∞–±–ª–∏—Ü–∞ –ø—É—Å—Ç–∞ []
‚Ä¢ "column does not exist" –æ—à–∏–±–∫–∞
‚Ä¢ RLS –±–ª–æ–∫–∏—Ä—É–µ—Ç –¥–æ—Å—Ç—É–ø
‚Ä¢ –î–∞–Ω–Ω—ã–µ –Ω–µ —Å–æ—Ö—Ä–∞–Ω—è—é—Ç—Å—è
‚Ä¢ –û—á–µ–Ω—å –º–µ–¥–ª–µ–Ω–Ω–æ —á–∏—Ç–∞—Ç—å/–ø–∏—Å–∞—Ç—å
```

**–î–∏–∞–≥–Ω–æ—Å—Ç–∏–∫–∞:**

#### 4.1 –¢–∞–±–ª–∏—Ü–∞ —Å—É—â–µ—Å—Ç–≤—É–µ—Ç?
```bash
# Supabase Dashboard ‚Üí SQL Editor

SELECT * FROM information_schema.tables
WHERE table_schema = 'public' AND table_name = 'sources';

# –†–µ–∑—É–ª—å—Ç–∞—Ç: –¥–æ–ª–∂–Ω–∞ –±—ã—Ç—å –æ–¥–Ω–∞ —Å—Ç—Ä–æ–∫–∞
```

#### 4.2 –î–∞–Ω–Ω—ã–µ –µ—Å—Ç—å –≤ —Ç–∞–±–ª–∏—Ü–µ?
```bash
SELECT COUNT(*) FROM sources;
# –†–µ–∑—É–ª—å—Ç–∞—Ç: > 0

SELECT * FROM sources LIMIT 1;
# –ü–æ—Å–º–æ—Ç—Ä–∏ —Å—Ç—Ä—É–∫—Ç—É—Ä—É –∏ –∑–Ω–∞—á–µ–Ω–∏—è
```

#### 4.3 –í—Å–µ –∫–æ–ª–æ–Ω–∫–∏ –ø—Ä–∞–≤–∏–ª—å–Ω—ã–µ?
```bash
SELECT column_name, data_type, is_nullable
FROM information_schema.columns
WHERE table_name = 'sources'
ORDER BY ordinal_position;

# –ü—Ä–æ–≤–µ—Ä—å:
# ‚úÖ id           | uuid          | NO
# ‚úÖ name         | character varying | NO
# ‚úÖ source_type_id | uuid        | NO
# ‚úÖ website_url  | text          | YES
# ‚úÖ telegram_channel | character varying | YES
# ‚úÖ priority     | integer       | NO
# ‚úÖ is_active    | boolean       | YES

# –ï—Å–ª–∏ –¥—Ä—É–≥–∏–µ –∏–º–µ–Ω–∞ ‚Üí –æ–±–Ω–æ–≤–∏—Ç—å –∫–æ–¥
```

#### 4.4 RLS –ø–æ–∑–≤–æ–ª—è–µ—Ç –¥–æ—Å—Ç—É–ø?
```bash
# –ü—Ä–æ–≤–µ—Ä–∏—Ç—å –≤—Å–µ –ø–æ–ª–∏—Ç–∏–∫–∏ –Ω–∞ —Ç–∞–±–ª–∏—Ü–µ
SELECT polname, poltype, poldefine FROM pg_policy
WHERE polrelid = 'sources'::regclass;

# –ù—É–∂–Ω–∞ –ø–æ–ª–∏—Ç–∏–∫–∞ —Ç–∏–ø–∞ SELECT —Å USING (true) –¥–ª—è –ø—É–±–ª–∏—á–Ω–æ–≥–æ –¥–æ—Å—Ç—É–ø–∞
# –ï—Å–ª–∏ –≤–∏–¥–∏—à—å USING (auth.role() = 'authenticated')
#  ‚Üí —Å–æ–∑–¥–∞—Ç—å/–æ–±–Ω–æ–≤–∏—Ç—å –ø–æ–ª–∏—Ç–∏–∫—É

# –ú–∏–Ω–∏–º–∞–ª—å–Ω—ã–π fix:
DROP POLICY IF EXISTS "Sources viewable by authenticated users" ON sources;
CREATE POLICY "Sources viewable by all"
  ON sources FOR SELECT
  USING (true);
```

#### 4.5 –í—Å—Ç–∞–≤–∫–∞ —Ä–∞–±–æ—Ç–∞–µ—Ç?
```bash
# –ü—Ä—è–º–æ–π —Ç–µ—Å—Ç –≤—Å—Ç–∞–≤–∫–∏
INSERT INTO sources (name, source_type_id, priority)
VALUES ('Test Source', 'd36b3d6c-34a5-435c-b5b4-dc036ff50b04', 5)
RETURNING *;

# –ï—Å–ª–∏ —É—Å–ø–µ—Ö ‚Üí INSERT —Ä–∞–±–æ—Ç–∞–µ—Ç
# –ï—Å–ª–∏ –æ—à–∏–±–∫–∞ ‚Üí –µ—Å—Ç—å –ø—Ä–æ–±–ª–µ–º–∞ —Å constraint –∏–ª–∏ trigger

# –ü—Ä–æ–≤–µ—Ä–∏—Ç—å constraints:
SELECT constraint_name, constraint_type
FROM information_schema.table_constraints
WHERE table_name = 'sources';
```

---

## üß™ –ü–æ—à–∞–≥–æ–≤—ã–µ —Ç–µ—Å—Ç—ã –¥–ª—è –∫–∞–∂–¥–æ–≥–æ —É—Ä–æ–≤–Ω—è

### –¢–µ—Å—Ç –£—Ä–æ–≤–Ω—è 1: Frontend –º–æ–∂–µ—Ç –≤—ã–∑–≤–∞—Ç—å —Ñ—É–Ω–∫—Ü–∏—é?

```typescript
// –í frontend –∫–æ–¥–µ:
const testPipelineCall = async () => {
  try {
    console.log('1Ô∏è‚É£ Testing frontend ‚Üí orchestrator call');

    const { data, error } = await supabase.functions.invoke(
      'search-orchestrator',
      {
        body: {
          monitoring_profile_id: 'e136307c-2630-4281-a7b2-739f3ebade3b',
        },
      }
    );

    if (error) {
      console.error('‚ùå Frontend error:', error);
      return;
    }

    console.log('‚úÖ Frontend call successful:', data);
  } catch (error) {
    console.error('‚ùå Exception:', error);
  }
};
```

### –¢–µ—Å—Ç –£—Ä–æ–≤–Ω—è 2: Orchestrator —Ä–∞–±–æ—Ç–∞–µ—Ç?

```bash
# Bash script
#!/bin/bash

echo "2Ô∏è‚É£ Testing orchestrator function"

RESULT=$(curl -s -X POST \
  https://your-project.supabase.co/functions/v1/search-orchestrator \
  -H "Content-Type: application/json" \
  -H "apikey: $ANON_KEY" \
  -H "Authorization: Bearer $JWT_TOKEN" \
  -d '{"monitoring_profile_id":"e136307c-2630-4281-a7b2-739f3ebade3b"}')

echo "Response:"
echo $RESULT | jq .

# –ü—Ä–æ–≤–µ—Ä–∏—Ç—å –Ω–∞–ª–∏—á–∏–µ:
if echo $RESULT | jq -e '.status' > /dev/null; then
  echo "‚úÖ Orchestrator returned valid JSON"
else
  echo "‚ùå Invalid response from orchestrator"
fi
```

### –¢–µ—Å—Ç –£—Ä–æ–≤–Ω—è 3: –ê–≥–µ–Ω—Ç –º–æ–∂–µ—Ç —Ä–∞–±–æ—Ç–∞—Ç—å –Ω–µ–∑–∞–≤–∏—Å–∏–º–æ?

```bash
# –¢–µ—Å—Ç source-hunter –Ω–µ–∑–∞–≤–∏—Å–∏–º–æ
curl -X POST https://.../functions/v1/source-hunter \
  -H "apikey: $ANON_KEY" \
  -H "Content-Type: application/json" \
  -d '{
    "prompt": "test query",
    "segment_ids": ["segment-id"],
    "geography_ids": ["geography-id"]
  }' | jq .

# –†–µ–∑—É–ª—å—Ç–∞—Ç –¥–æ–ª–∂–µ–Ω –±—ã—Ç—å:
# {
#   "status": "success",
#   "documents_created": N,
#   "document_ids": [...],
#   "urls": [...]
# }
```

### –¢–µ—Å—Ç –£—Ä–æ–≤–Ω—è 4: –ë–î –¥–æ—Å—Ç—É–ø–Ω–∞ –∏ –ø—Ä–∞–≤–∏–ª—å–Ω–∞—è?

```bash
# –ë—ã—Å—Ç—Ä—ã–π —Ç–µ—Å—Ç –¥–æ—Å—Ç—É–ø–∞ –∫ —Ç–∞–±–ª–∏—Ü–µ
curl -H "apikey: $ANON_KEY" \
  'https://your-project.supabase.co/rest/v1/sources?limit=1' \
  | jq '.[] | {id, name, source_type_id, website_url}'

# –†–µ–∑—É–ª—å—Ç–∞—Ç: –¥–∞–Ω–Ω—ã–µ –∏–∑ —Ç–∞–±–ª–∏—Ü—ã –∏–ª–∏ [] –µ—Å–ª–∏ –ø—É—Å—Ç–æ

# –ü—Ä–æ–≤–µ—Ä–∏—Ç—å —á—Ç–æ –≤–∏–¥–∏—à—å:
# {
#   "id": "uuid",
#   "name": "–†—É—Å–∫–ª–∏–º–∞—Ç",
#   "source_type_id": "uuid",
#   "website_url": "https://rusclimate.ru"
# }
```

---

## üéØ –î–µ—Ä–µ–≤–æ —Ä–µ—à–µ–Ω–∏–π: –ì–¥–µ –æ—à–∏–±–∫–∞?

```
                    Pipeline –Ω–µ —Ä–∞–±–æ—Ç–∞–µ—Ç
                           |
                           v
                    –ö–∞–∫–æ–π —Å—Ç–∞—Ç—É—Å –∫–æ–¥?
                 /          |          \
               /            |            \
              /             |             \
            404            400           500/timeout
            |               |               |
            |               |               |
    –§—É–Ω–∫—Ü–∏—è –Ω–µ      –ù–µ–ø—Ä–∞–≤–∏–ª—å–Ω—ã–µ    –û—à–∏–±–∫–∞ –≤ –∫–æ–¥–µ
    –Ω–∞–π–¥–µ–Ω–∞         –ø–∞—Ä–∞–º–µ—Ç—Ä—ã       —Ñ—É–Ω–∫—Ü–∏–∏
            |               |               |
            v               v               v
    1. URL –ø—É—Ç—å?    1. –ü–æ—Å–º–æ—Ç—Ä–∏      1. –õ–æ–≥–∏ –≤
    2. –†–∞–∑–≤–µ—Ä–Ω—É—Ç–∞?     types.ts         Dashboard
    3. –ù–µ—Ç –¥—É–±–ª–µ–π?  2. –ü—Ä–æ–≤–µ—Ä—å      2. –ö–∞–∫–æ–π —à–∞–≥
                       —á—Ç–æ –æ—Ç–ø—Ä–∞–≤–ª—è–µ—à—å  —Å–ª–æ–º–∞–ª—Å—è?
                    3. –§–æ—Ä–º        3. –ü–æ–≤—Ç–æ—Ä–∏
                       –ø—Ä–æ–≤–µ—Ä–∫–∞      —à–∞–≥ –æ—Ç–¥–µ–ª—å–Ω–æ
                                  4. Fix ‚Üí redeploy
```

---

## üìã –ë—ã—Å—Ç—Ä–∞—è —Å–ø—Ä–∞–≤–∫–∞: –ß—Ç–æ –ø—Ä–æ–≤–µ—Ä–∏—Ç—å –≤ –ø–µ—Ä–≤—ã—Ö 5 –º–∏–Ω—É—Ç

```
‚ñ° –§—É–Ω–∫—Ü–∏—è —Ä–∞–∑–≤–µ—Ä–Ω—É—Ç–∞?
  npx supabase functions list | grep <name>

‚ñ° –ù–æ–≤—ã–π –∫–æ–¥ –∑–∞–ø—É—â–µ–Ω?
  curl .../functions/v1/<name> -d '...'
  # –°–º–æ—Ç—Ä–∏ –≤ Logs ‚Üí –≤–∏–¥–∏—à—å –Ω–æ–≤—ã–µ —ç–º–æ–¥–∑–∏ –ª–æ–≥–∏?

‚ñ° URL –ø—Ä–∞–≤–∏–ª—å–Ω—ã–π?
  # /functions/v1/{NAME} - –ø—Ä–∞–≤–∏–ª—å–Ω–æ
  # /functions/v1/agents/{NAME} - –Ω–µ–ø—Ä–∞–≤–∏–ª—å–Ω–æ

‚ñ° RLS –Ω–µ –±–ª–æ–∫–∏—Ä—É–µ—Ç?
  curl -H "apikey: $ANON_KEY" .../rest/v1/table?limit=1
  # [] - –≤–æ–∑–º–æ–∂–Ω–æ RLS
  # [data] - OK

‚ñ° –¢–∏–ø—ã –¥–∞–Ω–Ω—ã—Ö —Å–æ–≤–ø–∞–¥–∞—é—Ç?
  # SELECT * FROM table;
  # –ü—Ä–æ–≤–µ—Ä—å —á—Ç–æ column names –≤ –∫–æ–¥–µ —Å–æ–≤–ø–∞–¥–∞—é—Ç

‚ñ° –ü–∞—Ä–∞–º–µ—Ç—Ä—ã –ø—Ä–∞–≤–∏–ª—å–Ω—ã–µ?
  # –ü–æ—Å–º–æ—Ç—Ä–∏ types.ts —Ñ—É–Ω–∫—Ü–∏–∏
  # –ß—Ç–æ –æ–∂–∏–¥–∞–µ—Ç –Ω–∞ –≤—Ö–æ–¥?
```

---

## üö® –¢–∏–ø–∏—á–Ω—ã–µ –ø–∞—Ç—Ç–µ—Ä–Ω—ã –æ—à–∏–±–æ–∫

| –û—à–∏–±–∫–∞ | –ü—Ä–∏—á–∏–Ω–∞ | –†–µ—à–µ–Ω–∏–µ |
|--------|---------|---------|
| 404 Not Found | –ù–µ–ø—Ä–∞–≤–∏–ª—å–Ω—ã–π URL –∏–ª–∏ –¥—É–±–ª–∏—Ä–æ–≤–∞–Ω–∏–µ | –ü—Ä–æ–≤–µ—Ä–∏—Ç—å URL, find –¥—É–±–ª–µ–π |
| 400 Bad Request | –ù–µ–ø—Ä–∞–≤–∏–ª—å–Ω—ã–π —Ñ–æ—Ä–º–∞—Ç –¥–∞–Ω–Ω—ã—Ö | –ü–æ—Å–º–æ—Ç—Ä–∏ types.ts, check JSON |
| 500 Server Error | –û—à–∏–±–∫–∞ –≤ –∫–æ–¥–µ | –°–º–æ—Ç—Ä–∏ –ª–æ–≥–∏, –¥–æ–±–∞–≤—å console.log |
| `[]` –ü—É—Å—Ç–æ | RLS –±–ª–æ–∫–∏—Ä—É–µ—Ç –∏–ª–∏ –Ω–µ—Ç –¥–∞–Ω–Ω—ã—Ö | CREATE POLICY ... USING (true) |
| –ú–µ–¥–ª–µ–Ω–Ω–æ | –ú–Ω–æ–≥–æ –æ–ø–µ—Ä–∞—Ü–∏–π –∏–ª–∏ network lag | Promise.all, optimize |
| Timeout | –§—É–Ω–∫—Ü–∏—è —Ä–∞–±–æ—Ç–∞–µ—Ç > 10 –º–∏–Ω—É—Ç | –û–ø—Ç–∏–º–∏–∑–∏—Ä–æ–≤–∞—Ç—å –∏–ª–∏ –±–∞—Ç—á–∏—Ç—å |

---

**–í–µ—Ä—Å–∏—è:** 1.0.0
**–î–∞—Ç–∞:** 2025-12-14
